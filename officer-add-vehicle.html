<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Vehicle - LTO VIS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        /* --- CSS STYLES --- */
        :root {
            --lto-blue: #0056a6;
            --lto-light-blue: #e6f0ff;
            --lto-dark-blue: #003d7a;
            --lto-yellow: #ffcc00;
            --lto-white: #ffffff;
            --lto-gray: #f5f5f5;
            --lto-dark-gray: #333333;
            --lto-light-gray: #e0e0e0;
            --lto-green: #28a745;
            --lto-red: #dc3545;
            --lto-orange: #fd7e14;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: var(--lto-dark-blue);
            color: var(--lto-white);
            height: 100vh;
            position: fixed;
            transition: all 0.3s;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            background-color: var(--lto-blue);
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header .logo {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .sidebar-menu {
            padding: 15px 0;
        }

        .sidebar-menu ul {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--lto-white);
            border-left-color: var(--lto-yellow);
        }

        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--lto-light-gray);
        }

        .page-title h1 {
            font-size: 24px;
            color: var(--lto-dark-blue);
            margin-bottom: 5px;
        }

        .page-title p {
            color: var(--lto-dark-gray);
            font-size: 14px;
        }

        .user-menu {
            display: flex;
            align-items: center;
        }

        .user-info {
            text-align: right;
            margin-right: 15px;
        }

        .user-name {
            font-weight: 600;
            color: var(--lto-dark-blue);
        }

        .user-role {
            font-size: 12px;
            color: var(--lto-dark-gray);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--lto-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .form-container {
            background-color: var(--lto-white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--lto-light-gray);
        }
        
        .form-container .form-section:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-title {
            font-size: 18px;
            color: var(--lto-dark-blue);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 10px;
            color: var(--lto-blue);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-col {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--lto-dark-gray);
            font-weight: 500;
        }

        .required::after {
            content: " *";
            color: var(--lto-red);
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--lto-light-gray);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--lto-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 86, 166, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        /* Add this to your existing CSS */
        .photo-upload {
            opacity: 0.6;
            cursor: not-allowed !important;
        }

        .photo-upload:hover {
            border-color: var(--lto-light-gray) !important;
            background-color: var(--lto-white) !important;
        }

        .photo-upload i {
            font-size: 48px;
            color: var(--lto-blue);
            margin-bottom: 15px;
        }

        .upload-text {
            color: var(--lto-dark-gray);
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: var(--lto-dark-gray);
            font-size: 12px;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .btn i {
            margin-right: 8px;
        }

        .btn-primary {
            background-color: var(--lto-blue);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--lto-dark-blue);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--lto-blue);
            color: var(--lto-blue);
        }

        .btn-outline:hover {
            background-color: var(--lto-light-blue);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--lto-light-gray);
        }

        /* --- Modal Styles --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1001; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 30px;
            border-radius: 8px;
            width: 90%; 
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation-name: animatetop;
            animation-duration: 0.4s
        }

        @keyframes animatetop {
            from {top:-300px; opacity:0}
            to {top:0; opacity:1}
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-header {
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--lto-light-gray);
            text-align: center;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        #qrcodeCanvas {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid var(--lto-light-gray);
            border-radius: 4px;
        }

        .qr-info h4 {
            color: var(--lto-dark-blue);
            margin-bottom: 5px;
        }

        .qr-info p {
            font-size: 14px;
            color: var(--lto-dark-gray);
        }

        .scanner-info {
            background: var(--lto-light-blue);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: left;
        }

        .scanner-info h4 {
            color: var(--lto-dark-blue);
            margin-bottom: 10px;
        }

        .scanner-info ol {
            padding-left: 20px;
        }

        .scanner-info li {
            margin-bottom: 8px;
            font-size: 14px;
        }
        /* --- End Modal Styles --- */

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar .menu-text, .sidebar-header h2 {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="40" height="40" rx="8" fill="white"/>
                    <path d="M10 20C10 14.4772 14.4772 10 20 10C25.5228 10 30 14.4772 30 20C30 25.5228 25.5228 30 20 30C14.4772 30 10 25.5228 10 20Z" fill="#0056a6"/>
                    <rect x="15" y="15" width="10" height="10" rx="2" fill="white"/>
                </svg>
            </div>
            <h2>LTO VIS</h2>
        </div>
        <div class="sidebar-menu">
    <ul>
        <li><a href="officer-dashboard.html"><i class="fas fa-tachometer-alt"></i> <span class="menu-text">Dashboard</span></a></li>
        <li><a href="officer-add-vehicle.html" class="active"><i class="fas fa-car-side"></i> <span class="menu-text">Add Vehicle</span></a></li>
        <li><a href="officer-my-vehicles.html"><i class="fas fa-list"></i> <span class="menu-text">My Vehicles</span></a></li>
        <li><a href="#"><i class="fas fa-sign-out-alt"></i> <span class="menu-text">Logout</span></a></li>
    </ul>
</div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title">
                <h1>Add Vehicle</h1>
                <p>Record a new impounded vehicle.</p>
            </div>
            <div class="user-menu">
                <div class="user-info">
                    <div class="user-name">Officer Juan</div>
                    <div class="user-role">Impounding Officer</div>
                </div>
                <div class="user-avatar">OJ</div>
            </div>
        </div>

        <div class="form-container">
            <form id="impoundForm">
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-user-circle"></i> Owner Information</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="ownerName" class="required">Owner's Full Name</label>
                                <input type="text" id="ownerName" placeholder="e.g., Maria Santos Cruz" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="ownerContact">Contact Number</label>
                                <input type="text" id="ownerContact" placeholder="e.g., 0917xxxxxxx">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-car"></i> Vehicle Information</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="plateNumber" class="required">Plate Number</label>
                                <input type="text" id="plateNumber" placeholder="e.g., ABC 1234" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="vehicleType" class="required">Vehicle Type</label>
                                <select id="vehicleType" required>
                                    <option value="">Select Vehicle Type</option>
                                    <option value="sedan">Sedan</option>
                                    <option value="suv">SUV</option>
                                    <option value="motorcycle">Motorcycle</option>
                                    <option value="van">Van</option>
                                    <option value="truck">Truck</option>
                                    <option value="bus">Bus</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="vehicleModel" class="required">Vehicle Model</label>
                                <input type="text" id="vehicleModel" placeholder="e.g., Toyota Vios" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="vehicleColor" class="required">Color</label>
                                <input type="text" id="vehicleColor" placeholder="e.g., Red" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-exclamation-triangle"></i> Violation Information</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="violation" class="required">Violation Type</label>
                                <select id="violation" required>
                                    <option value="">Select Violation</option>
                                    <option value="illegal_parking">Illegal Parking</option>
                                    <option value="no_registration">No Registration</option>
                                    <option value="reckless_driving">Reckless Driving</option>
                                    <option value="no_license">No Driver's License</option>
                                    <option value="overspeeding">Overspeeding</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="violationDetails">Violation Details</label>
                                <textarea id="violationDetails" rows="3" placeholder="Additional details about the violation..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-map-marker-alt"></i> Impound Details</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="impoundDate" class="required">Impound Date</label>
                                <input type="date" id="impoundDate" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="impoundTime" class="required">Impound Time</label>
                                <input type="time" id="impoundTime" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="towingLocation" class="required">Towing Location</label>
                                <input type="text" id="towingLocation" placeholder="Location where vehicle was towed from" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="slotNumber" class="required">Slot Number</label>
                                <input type="text" id="slotNumber" placeholder="e.g., A-15" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-camera"></i> Vehicle Photos</h3>
                    <div class="form-group">
                        <div class="photo-upload" id="photoUpload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <div class="upload-text">Photo upload disabled (Upgrade plan to enable)</div>
                            <div class="upload-subtext">Storage feature requires Blaze plan</div>
                            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" disabled>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-sticky-note"></i> Condition Notes</h3>
                    <div class="form-group">
                        <label for="conditionNotes">Vehicle Condition Notes</label>
                        <textarea id="conditionNotes" rows="4" placeholder="Describe the vehicle's current condition, any damages, etc."></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-outline">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveAndGenerateBtn">
                        <i class="fas fa-qrcode"></i> Save & Generate QR
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="qrModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <div class="modal-header">
            <h2>Vehicle Added Successfully!</h2>
            <p>QR code generated for the impounded vehicle.</p>
        </div>
        <div class="modal-body">
            <canvas id="qrcodeCanvas"></canvas>
            <div class="qr-info">
                <h4>Vehicle: <span id="modalPlateNumber"></span></h4>
                <p>Owner: <span id="modalOwnerName"></span></p>
            </div>
            
            <div class="scanner-info">
                <h4>Next Steps:</h4>
                <ol>
                    <li>Print this QR code and attach to the vehicle</li>
                    <li>Scan with any QR scanner to view vehicle details</li>
                    <li>Manage vehicles in "My Vehicles" section</li>
                </ol>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-primary" onclick="printQrSticker()" style="flex: 1;">
                    <i class="fas fa-print"></i> Print QR Sticker
                </button>
                <button type="button" class="btn btn-outline" onclick="closeModalAndRedirect()" style="flex: 1;">
                    <i class="fas fa-list"></i> View My Vehicles
                </button>
            </div>
        </div>
    </div>
</div>


    <script type="module">

        

        // Import Firebase modules (NO STORAGE)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        
        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyByzd88bcUAq0VdP0w6oB8W_b2AUgoIzXc",
            authDomain: "vehicle-impound.firebaseapp.com",
            projectId: "vehicle-impound",
            storageBucket: "vehicle-impound.appspot.com",
            messagingSenderId: "69239563292",
            appId: "1:69239563292:web:281912e8a38301c0feabd9"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DOM Elements
        const impoundForm = document.getElementById('impoundForm');
        const qrModal = document.getElementById('qrModal');
        const closeModalBtn = document.getElementById('closeModal');
        const saveBtn = document.getElementById('saveAndGenerateBtn');
        const qrcodeCanvas = document.getElementById('qrcodeCanvas');

        // Generate QR Code function
        async function generateQrCode(qrData) {
            return new Promise((resolve, reject) => {
                QRCode.toCanvas(qrcodeCanvas, qrData, { 
                    errorCorrectionLevel: 'H', 
                    width: 200, 
                    margin: 2 
                }, (error) => {
                    if (error) {
                        console.error("QR Code generation failed: ", error);
                        reject("Failed to generate QR Code image.");
                    } else {
                        resolve(qrcodeCanvas.toDataURL("image/png"));
                    }
                });
            });
        }

        // Print QR function
        window.printQrSticker = function() {
    const qrDataURL = qrcodeCanvas.toDataURL("image/png");
    const printWindow = window.open('', '', 'width=400,height=400');
    printWindow.document.write('<html><head><title>Print QR Sticker</title>');
    printWindow.document.write('<style>body{text-align:center;font-family:sans-serif;} img{max-width:100%;}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write('<h3>LTO Impound Tag</h3>');
    printWindow.document.write(`<img src="${qrDataURL}" style="border: 2px solid black; padding: 10px;">`);
    printWindow.document.write(`<h4>Plate: ${document.getElementById('modalPlateNumber').textContent}</h4>`);
    printWindow.document.write(`<p>Impound Date: ${document.getElementById('impoundDate').value}</p>`);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
};

function closeModalAndRedirect() {
    document.getElementById('qrModal').style.display = "none";
    window.location.href = 'officer-my-vehicles.html';
} 
        // Event Listeners
        closeModalBtn.addEventListener('click', () => {
            qrModal.style.display = "none";
        });

        window.onclick = (event) => {
            if (event.target == qrModal) {
                qrModal.style.display = "none";
            }
        };

        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('impoundDate').value = today;

        // Form Submission (NO PHOTO UPLOAD)
        impoundForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Basic validation
            const requiredFields = ['ownerName', 'plateNumber', 'vehicleType', 'vehicleModel', 'vehicleColor', 'violation', 'impoundDate', 'impoundTime', 'towingLocation', 'slotNumber'];
            let isValid = true;
            
            requiredFields.forEach(field => {
                const element = document.getElementById(field);
                if (!element.value.trim()) {
                    isValid = false;
                    element.style.borderColor = 'var(--lto-red)';
                } else {
                    element.style.borderColor = '';
                }
            });
            
            if (!isValid) {
                alert('Please fill in all required fields (marked with *)');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving Vehicle...';
            
            // Gather form data
            const formData = {
                ownerName: document.getElementById('ownerName').value.trim(),
                ownerContact: document.getElementById('ownerContact').value.trim(),
                plateNumber: document.getElementById('plateNumber').value.toUpperCase().trim(),
                vehicleType: document.getElementById('vehicleType').value,
                vehicleModel: document.getElementById('vehicleModel').value.trim(),
                vehicleColor: document.getElementById('vehicleColor').value.trim(),
                violation: document.getElementById('violation').value,
                violationDetails: document.getElementById('violationDetails').value.trim(),
                impoundDate: document.getElementById('impoundDate').value,
                impoundTime: document.getElementById('impoundTime').value,
                towingLocation: document.getElementById('towingLocation').value.trim(),
                slotNumber: document.getElementById('slotNumber').value.toUpperCase().trim(),
                conditionNotes: document.getElementById('conditionNotes').value.trim(),
                impoundingOfficer: "Officer Juan", 
                timestamp: new Date().toISOString(),
                status: "impounded",
                photoUrls: [], // Empty since no photo upload
                qrCodeImage: null 
            };

            try {
                // 1. Save to Firestore
                console.log("Saving vehicle to Firestore...");
                const docRef = await addDoc(collection(db, "impoundedVehicles"), formData);
                const docId = docRef.id;
                console.log("✅ Document created with ID: ", docId);

                // 2. Generate QR Code with URL that opens scanner directly
// Minimal QR data - just the document ID
const qrDataForScanner = `https://add-vehicle-smoky.vercel.app/scanner.html?id=${docId}`;
const qrImageBase64 = await generateQrCode(qrDataForScanner);

                // 3. Update document with QR code
await updateDoc(doc(db, "impoundedVehicles", docId), {
    qrCodeImage: qrImageBase64,
    // Remove any reference to vehicleData here
});

// 4. Show success modal
document.getElementById('modalPlateNumber').textContent = formData.plateNumber;
document.getElementById('modalOwnerName').textContent = formData.ownerName;
qrModal.style.display = "block";

                // 5. Reset form
impoundForm.reset();
document.getElementById('impoundDate').value = today;

console.log("✅ Vehicle added successfully!");
// console.log("QR Code contains:", vehicleData); // ← REMOVE OR COMMENT THIS LINE

} catch (error) {
    console.error("❌ Error saving vehicle: ", error);
    alert("Error saving vehicle: " + error.message);
} finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="fas fa-qrcode"></i> Save & Generate QR';
}
        });
    </script>
</body>
</html>